[workspace]
name = "robostack"
description = "Development environment for RoboStack ROS packages"
channels = ["https://prefix.dev/conda-forge"]
platforms = ["linux-64", "win-64", "osx-64", "osx-arm64", "linux-aarch64"]

# ROS environment is automatically activated by RoboStack via conda activation scripts
# Additional environment configuration for ROS DDS settings

[target.unix.activation]
scripts = ["scripts/activate-cyclonedds.sh"]

[target.win.activation]
scripts = ["scripts/activate-cyclonedds.bat"]

# To build you can use - `pixi run -e <ros distro> build <Any other temporary args>`

# Guard tasks - show helpful errors when you forget '-e jazzy'
[tasks]
build = { cmd = 'python -c "import sys; print(\"This task requires: pixi run -e jazzy build\"); sys.exit(2)"' }
sim   = { cmd = "pixi run -e jazzy sim" }
slam  = { cmd = 'python -c "import sys; print(\"This task requires: pixi run -e jazzy slam\"); sys.exit(2)"' }
clean = { cmd = 'python -c "import sys; print(\"Use: pixi run -e jazzy clean\"); sys.exit(2)"' }
rebuild = { cmd = 'python -c "import sys; print(\"Use: pixi run -e jazzy rebuild\"); sys.exit(2)"' }


# Dependencies used by all environments
[dependencies]
python = "*"
# Build tools
compilers = "*"
cmake = "*"
pkg-config = "*"
make = "*"
ninja = "*"
# ROS specific tools
rosdep = "*"
colcon-common-extensions = "*"

[target.linux.dependencies]
libgl-devel = "*"
libprotobuf = "*"

[target.osx.dependencies]
libprotobuf = "*"

[target.win-64.dependencies]    
protobuf = "*"

# Define all the different ROS environments
# Each environment corresponds to a different ROS distribution
# and can be activated using the `pixi run/shell -e <environment>` command.
[environments]
# noetic = { features = ["noetic", "build"] }
# humble = { features = ["humble", "build"] }
jazzy = { features = ["jazzy"] }
# kilted = { features = ["kilted", "build"] }

### ROS Noetic ####  
# [feature.noetic]
# channels = ["https://prefix.dev/robostack-noetic"]

# [feature.noetic.dependencies]
# ros-noetic-desktop = "*"
# catkin_tools = "*"

# ### ROS Humble ####
# [feature.humble]
# channels = ["https://prefix.dev/robostack-humble"]

# [feature.humble.dependencies]
# ros-humble-desktop = "*"

### ROS Jazzy ####
[feature.jazzy]
channels = ["https://prefix.dev/robostack-jazzy"]



[feature.jazzy.dependencies]
ros-jazzy-desktop = "*"
ros-jazzy-ros-base = ">=0.11.0,<0.12"
ros-jazzy-rviz2 = ">=14.1.12,<15"
ros-jazzy-ros-gz-sim = ">=1.0.16,<2"
ros-jazzy-ros-gz-interfaces = ">=1.0.16,<2"
ros-jazzy-ros-gz-bridge = ">=1.0.16,<2"
ros-jazzy-slam-toolbox = ">=2.8.3,<3"
ros-jazzy-sensor-msgs = ">=5.3.6,<6"
ros-jazzy-geometry-msgs = ">=5.3.6,<6"
ros-jazzy-std-msgs = ">=5.3.6,<6"
ros-jazzy-nav-msgs = ">=5.3.6,<6"
ros-jazzy-rclpy = ">=7.1.0,<8"
colcon-common-extensions = ">=0.3.0,<0.4"
cmake = ">=4.1.1,<5"
pkg-config = ">=0.29.2,<0.30"
ninja = ">=1.13.1,<2"
numpy = ">=1.26.4,<2"
eigen = ">=3.4.0,<4"
pcl = ">=1.15.0,<2"
tinyxml2 = "*"
qt-main = "*"
ffmpeg = "*"
git = "*"
pip = "*"

[feature.jazzy.pypi-dependencies]
kconfiglib = "*"
pyros-genmsg = "*"
jinja2 = "*"
jsonschema = "*"
future = "*"

[feature.jazzy.target.linux-64.pypi-dependencies]
symforce = "*"

[feature.jazzy.target.osx-64.pypi-dependencies]
symforce = "*"

# Tasks that exist ONLY when you run: pixi run -e jazzy <task>
[feature.jazzy.tasks]
build   = "colcon build --merge-install --install-base $CONDA_PREFIX --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON"
clean   = "rm -rf build log"
rebuild = "pixi run -e jazzy clean && pixi run -e jazzy build"
old_sim    = "ros2 launch tof_slam_sim sim_with_bridge.launch.py"
slam    = "ros2 launch tof_slam_sim slam_test.launch.py"
build_px4 = "cd PX4-Autopilot && DONT_RUN=1 make px4_sitl gz_x500_small_tof CMAKE_ARGS=\"-DCONFIG_WARN_AS_ERROR=n\""
run_px4 = "cd PX4-Autopilot && make px4_sitl gz_x500_small_tof CMAKE_ARGS=\"-DCONFIG_WARN_AS_ERROR=n\""
px4_sitl = "ros2 launch tof_slam_sim px4_sitl.launch.py"
bridge_tof = """
ros2 run ros_gz_bridge parameter_bridge \
/depth/tof_1@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_2@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_3@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_4@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_5@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_6@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_7@sensor_msgs/msg/Image@gz.msgs.Image \
/depth/tof_8@sensor_msgs/msg/Image@gz.msgs.Image \
/model/x500_small_tof_0/pose@geometry_msgs/msg/PoseStamped@gz.msgs.Pose
"""
sim     = "AP_MODE=explore ros2 launch tof_slam_sim slam_test.launch.py"
bridge  = "ros2 run ros_gz_bridge parameter_bridge --ros-args -p config_file:=/home/rex/gazebo-slam-prototype/tof_slam_sim/config/bridge.yaml"
launch_robot1 = "ros2 run teleop_twist_keyboard teleop_twist_keyboard --ros-args -r cmd_vel:=/robot1/cmd_vel"

# Unix/macOS: faster iteration with symlinks
[feature.jazzy.target.unix.tasks]
build = "colcon build --symlink-install --merge-install --install-base $CONDA_PREFIX --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON"

# Windows variant (no symlinks)
[feature.jazzy.target.win-64.tasks]
build = "colcon build --merge-install --install-base %CONDA_PREFIX% --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON"

### ROS Kilted ####
# [feature.kilted]
# channels = ["https://prefix.dev/robostack-kilted"]

# [feature.kilted.dependencies]
# ros-kilted-desktop = "*"
